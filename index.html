<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Web Editor</title>
    <link rel="stylesheet" href="src/ui/styles.css">
    
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
</head>
<body>
    <div id="app">
        <!-- Main Toolbar -->
        <div class="toolbar" id="main-toolbar">
            <div class="toolbar-group">
                <button class="tool-btn" id="new-scene" title="New Scene">üìÑ</button>
                <button class="tool-btn" id="open-scene" title="Open Scene">üìÇ</button>
                <button class="tool-btn" id="save-scene" title="Save Scene">üíæ</button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="undo" title="Undo">‚Ü∂</button>
                <button class="tool-btn" id="redo" title="Redo">‚Ü∑</button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="move-tool" title="Move Tool">‚Üî</button>
                <button class="tool-btn" id="rotate-tool" title="Rotate Tool">üîÑ</button>
                <button class="tool-btn" id="scale-tool" title="Scale Tool">‚§ß</button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="import-model" title="Import 3D Model">üìÅ</button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="wireframe-toggle" title="Toggle Wireframe">‚ä°</button>
                <button class="tool-btn" id="grid-toggle" title="Toggle Grid">‚äû</button>
                <button class="tool-btn" id="fullscreen-toggle" title="Fullscreen">‚õ∂</button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="play-scene" title="Play Scene">‚ñ∂</button>
                <button class="tool-btn" id="pause-scene" title="Pause Scene">‚è∏</button>
                <button class="tool-btn" id="stop-scene" title="Stop Scene">‚èπ</button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar -->
            <div class="sidebar" id="left-sidebar">
                <!-- Scene Hierarchy Panel -->
                <div class="panel" id="hierarchy-panel">
                    <div class="panel-header">
                        <h3>Scene Hierarchy</h3>
                    </div>
                    <div class="panel-content">
                        <div id="hierarchy-list">
                            <p>No objects in scene</p>
                        </div>
                    </div>
                </div>

                <!-- Components Panel -->
                <div class="panel" id="component-panel">
                    <div class="panel-header">
                        <h3>Components</h3>
                    </div>
                    <div class="panel-content">
                        <div id="component-list">
                            <div class="component-item" draggable="true" data-component="Script">
                                <span class="component-icon">üìú</span>
                                <span class="component-name">Script</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="Collider">
                                <span class="component-icon">üõ°</span>
                                <span class="component-name">Collider</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="Light">
                                <span class="component-icon">üí°</span>
                                <span class="component-name">Light</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viewport -->
            <div class="viewport" id="viewport">
                <div class="viewport-overlay">
                    <div class="viewport-info">
                        <span id="viewport-stats">Objects: 0 | FPS: 60</span>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="sidebar" id="right-sidebar">
                <!-- Inspector Panel -->
                <div class="panel" id="inspector-panel">
                    <div class="panel-header">
                        <h3>Inspector</h3>
                    </div>
                    <div class="panel-content">
                        <div id="inspector-content">
                            <p>Select an object to inspect</p>
                        </div>
                    </div>
                </div>

                <!-- Console Panel -->
                <div class="panel" id="console-panel">
                    <div class="panel-header">
                        <h3>Console</h3>
                        <button id="clear-console" title="Clear Console">üóë</button>
                    </div>
                    <div class="panel-content">
                        <div id="console-output"></div>
                        <div class="console-input">
                            <input type="text" id="console-input" placeholder="Enter command...">
                            <button id="console-submit">‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/SceneManager.js"></script>
    <script src="src/core/ComponentSystem.js"></script>
    <script src="src/core/AssetManager.js"></script>
    <script src="src/core/EditorCore.js"></script>
    <script src="src/ui/UIManager.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        const consoleOutput = document.getElementById('console-output');
        
        function addToConsole(message, type = 'log') {
            if (consoleOutput) {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'error' ? '#ff0000' : type === 'warn' ? '#ffff00' : '#00ff00';
                const div = document.createElement('div');
                div.innerHTML = `<span style="color: #888888;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
                consoleOutput.appendChild(div);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // Initialize editor
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing 3D Web Editor...');
                
                // Create core systems
                const eventBus = new EventBus();
                const sceneManager = new SceneManager(eventBus);
                const componentSystem = new ComponentSystem(eventBus);
                const assetManager = new AssetManager(eventBus);
                
                // Create editor core
                const editorCore = new EditorCore(eventBus, sceneManager, componentSystem, assetManager);
                EditorCore.setInstance(editorCore);
                
                // Initialize editor (this will also initialize UI)
                await editorCore.init();
                
                console.log('Editor initialization complete');
                
                // Setup global references for UI functions
                window.uiManager = editorCore.uiManager;
                
                // Setup basic event handlers
                setupEventHandlers(editorCore);
                
            } catch (error) {
                console.error('Failed to initialize editor:', error);
            }
        });
        
        function setupEventHandlers(editorCore) {
            // Scene control buttons
            document.getElementById('play-scene').addEventListener('click', () => {
                editorCore.playScene();
            });
            
            document.getElementById('pause-scene').addEventListener('click', () => {
                editorCore.pauseScene();
            });
            
            document.getElementById('stop-scene').addEventListener('click', () => {
                editorCore.stopScene();
            });
            
            // Import model button
            document.getElementById('import-model').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.glb,.gltf,.fbx,.obj,.dae,.3ds,.ply,.stl';
                input.multiple = true;
                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        files.forEach(file => {
                            editorCore.sceneManager.importModel(file)
                                .then(() => {
                                    console.log(`Model "${file.name}" imported successfully`);
                                })
                                .catch(error => {
                                    console.error(`Failed to import "${file.name}": ${error.message}`);
                                });
                        });
                    }
                };
                input.click();
            });
            
            // Clear console button
            document.getElementById('clear-console').addEventListener('click', () => {
                const consoleOutput = document.getElementById('console-output');
                if (consoleOutput) {
                    consoleOutput.innerHTML = '';
                }
            });
            
            // Console input
            const consoleInput = document.getElementById('console-input');
            const consoleSubmit = document.getElementById('console-submit');
            
            function executeConsoleCommand() {
                const command = consoleInput.value.trim();
                if (command && editorCore) {
                    try {
                        // Simple command execution
                        if (command === 'help') {
                            console.log('Available commands: help, addCube, addTestCube, clear, scriptStatus, testSelection');
                        } else if (command === 'addCube') {
                            editorCore.sceneManager.addObject('cube', {
                                name: 'ConsoleCube',
                                x: Math.random() * 10 - 5,
                                y: Math.random() * 10 - 5,
                                z: Math.random() * 10 - 5,
                                color: 0xff0000
                            });
                            console.log('Added cube via console command');
                        } else if (command === 'addTestCube') {
                            editorCore.sceneManager.addObject('cube', {
                                name: 'TestCube',
                                x: 0, y: 0, z: 0,
                                color: 0x00ff00
                            });
                            console.log('Added test cube at origin');
                        } else if (command === 'clear') {
                            editorCore.sceneManager.clearScene();
                            console.log('Scene cleared');
                        } else if (command === 'scriptStatus') {
                            const status = editorCore.componentSystem.getScriptStatus();
                            console.log('Script Status:', status);
                        } else if (command === 'testSelection') {
                            const objects = Array.from(editorCore.sceneManager.objects.values());
                            if (objects.length > 0) {
                                const firstObject = objects[0];
                                editorCore.sceneManager.selectObject(firstObject.id);
                                console.log(`Selected object: ${firstObject.name} (${firstObject.id})`);
                            } else {
                                console.log('No objects in scene to select');
                            }
                        } else {
                            console.log(`Unknown command: ${command}`);
                        }
                    } catch (error) {
                        console.error('Command execution error:', error);
                    }
                    consoleInput.value = '';
                }
            }
            
            consoleSubmit.addEventListener('click', executeConsoleCommand);
            consoleInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    executeConsoleCommand();
                }
            });
        }
    </script>
</body>
</html>

